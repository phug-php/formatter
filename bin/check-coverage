#!/usr/bin/php
<?php

$xmlFile = __DIR__.'/../coverage/result.xml';
$requiredCoverage = 80;

if (!file_exists($xmlFile)) {

    echo 'Error: Code coverage files not found. Please run `phpunit`.', PHP_EOL;
    exit(1);
}

echo "Validating code coverage...", PHP_EOL;

$xml = new SimpleXMLElement(file_get_contents($xmlFile));
$metrics = $xml->xpath('//metrics');
$totalElements = 0;
$checkedElements = 0;

foreach ($metrics as $metric) {

    $totalElements   += (int)$metric['elements'];
    $checkedElements += (int)$metric['coveredelements'];
}

$coverage = ($checkedElements / $totalElements) * 100;

if ($coverage < $requiredCoverage) {

    echo "Fail: Code coverage is {$coverage}%. You need to reach {$requiredCoverage}% to validate this build.", PHP_EOL;
    exit(1);
}

echo "Pass: Code Coverage {$coverage}%!", PHP_EOL;